using System.IO;
using Ckb.Molecule.Type;
using Ckb.Types;
using Newtonsoft.Json;
using Xunit;

namespace Ckb.Molecule.Tests.Type
{
    public class BlockSerializerTests
    {
        // Block data from AGGRON4, and `expected` calculated by `ckb-cli`
        [Fact]
        public void TestSerialize()
        {
            using StreamReader r = new StreamReader("../../../Fixtures/block.json");
            string json = r.ReadToEnd();
            Block block = JsonConvert.DeserializeObject<Block>(json);
            var expected = "0x2403000014000000e4000000cc010000160300000000000033cf3d1dc816fd3c72010000d50a0000000000000400001b00300200009dd635fda0e093e537b7eea56bcf7272cb107170330a30da3270e0dd0daf027b8e8c8951749096f7a1e86b4204655a6e52b381468faa3b6e2dba699dd586862ddad1ff8aba40d0aa41a8a12f4ac61a03c1df244501b8650cd702f10f3fcdf3136b809c54f8612326529ec47945301cb97c442a32e46c7390f9165e31df8ba98437323ea9c2a42e4556e19a9e8723000918d97226c000000075093a730aff06f3070631d8a8cc2de0a8ea1c267f942ce800000008000000e00000000c000000dc0000000000000033cf3d1db39cfc3c72010000d40a0000000000000400001a003002003e6936ef975d2f77055f473d0b661bf9dcc6604fdca1e0018bd3468fe7ff46299bd730ba9f1c57da5970c737914711156ab921ae205b4855197d7089556a84af000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006b76a1fd3fc2a42e75b671879e8723003e3798c210c0000000d872ce710aff0620e103220145a7c17e5fa6b232670856000000004a01000008000000420100000c000000d9000000cd0000001c00000020000000240000002800000058000000c100000000000000000000000000000001000000d50a0000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff690000000800000061000000100000001800000061000000fa35509053000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000da648442dbb7347e467d1d09da13e5cd3a0ef0e10c000000080000000000000069000000080000005d0000005d0000000c00000055000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000da648442dbb7347e467d1d09da13e5cd3a0ef0e104000000deadbeef01000000a08d86ccf2dd38685637";

            Assert.Equal(BlockSerializer.HexStringToBytes(expected), new BlockSerializer(block).Serialize());
        }
    }
}
